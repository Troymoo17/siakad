<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beranda - Institut Widya Pratama</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">
  <main class="flex-1 flex flex-col p-4 md:p-6 lg:p-8">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-xl md:text-1xl font-bold text-gray-800">Selamat Datang Di Sistem Informasi Akademik Institut Widya Pratama Pekalongan</h1>
        <div class="hidden md:flex items-center border border-gray-300 rounded-lg bg-white overflow-hidden w-64">
          <input type="text" placeholder="Pencarian" class="py-2 px-3 text-sm flex-1 focus:outline-none"/>
          <button class="p-2 text-gray-500 hover:text-blue-600 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </button>
        </div>
      </header>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <section class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Kinerja Pembelajaran</h2>
    <div class="flex flex-col items-center space-y-4">
      <div class="relative w-40 h-40 flex items-center justify-center flex-shrink-0">
        <div class="donut-chart" id="ipk-donut"></div>
        <div class="absolute flex flex-col items-center justify-center">
          <span class="text-4xl font-bold text-blue-900" id="main-page-ipk-value">Memuat...</span>
          <span class="text-xs text-gray-500">/ 4.00</span>
        </div>
      </div>
      <br />
      <div class="flex flex-col md:flex-row justify-around w-full gap-4">
        <div class="bg-white p-4 rounded-lg shadow-sm flex-1 text-center border border-gray-300">
          <div class="text-xs text-gray-500">Semester</div>
          <div class="text-2xl font-bold text-gray-800" id="main-page-semester">Memuat...</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm flex-1 text-center border border-gray-300">
          <div class="text-xs text-gray-500">Tahun Akademik</div>
          <div class="text-2xl font-bold text-gray-800" id="main-page-tahun-akademik">Memuat...</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm flex-1 text-center border border-gray-300">
          <div class="text-xs text-gray-500">SKS</div>
          <div class="text-2xl font-bold text-gray-800" id="main-page-sks">Memuat...</div>
        </div>
      </div>
    </div>
  </section>
  <div class="space-y-6">
    <section class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Pengumuman</h2>
        <a href="#" class="text-xs text-blue-600 hover:text-blue-800">Lihat pengumuman tiga bulan terakhir</a>
      </div>
      <div class="space-y-4 text-sm">
        <div class="pb-3 border-b border-gray-200">
          <div class="text-xs text-gray-500">26 Agustus 2025</div>
          <a href="#" class="font-medium text-blue-600 hover:text-blue-800">Jadwal input krs Gasal 2025/2026</a>
        </div>
        <div class="pb-3 border-b border-gray-200">
          <div class="text-xs text-gray-500">26 Agustus 2025</div>
          <a href="#" class="font-medium text-blue-600 hover:text-blue-800">Jadwal dan daftar peserta ujian sertifikasi CCNA</a>
        </div>
        <div class="pb-3 border-b border-gray-200">
          <div class="text-xs text-gray-500">26 Agustus 2025</div>
          <a href="#" class="font-medium text-blue-600 hover:text-blue-800">Surat adopsi hasil karya mahasiswa TTG</a>
        </div>
      </div>
    </section>
    <section class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-700">QUOTE OF THE DAY</h2>
      </div>
      <span class="font-bold text-blue-700">Jika harimu buruk maka tetaplah buruk.</span>
      <span class="text-sm text-gray-500">-anomali bumi</span>
    </section>
  </div>
  <section class="bg-white p-6 rounded-lg shadow-md mt-6 md:col-span-2 border border-gray-300">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Jadwal Kuliah Hari Ini</h2>
    <div id="jadwal-hari-ini-container">
        <p class="text-sm text-gray-500 italic">Memuat jadwal...</p>
    </div>
</section>
</div>
    </main>
  </div>
</body>
</html>
<script>
    let globalMahasiswaData = null;
    const setText = (selector, value) => {
        const element = document.querySelector(selector);
        if (element) element.textContent = value || 'Tidak tersedia';
    };
    const setValue = (selector, value) => {
        const element = document.querySelector(selector);
        if (element) element.value = value || '';
    };
    async function fetchDataAndPopulatePage() {
        const nim = localStorage.getItem('loggedInUserNim');
        if (!nim) {
            console.error("NIM tidak ditemukan di localStorage. Pengguna tidak login.");
            return;
        }
        try {
            const response = await fetch(`http://localhost/siakad_api/mahasiswa.php?nim=${nim}`);
            const apiResponse = await response.json();
            globalMahasiswaData = apiResponse.data[0];
            fetchIpkIpsData(nim);
            fetchJadwalHariIni(nim);
        } catch (error) {
            console.error('Terjadi masalah saat mengambil data:', error);
        }
    }
    async function fetchIpkIpsData(nim) {
        const url = `http://localhost/siakad_api/ipk_ips.php?nim=${nim}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const apiResponse = await response.json();
            const data = apiResponse.data;
            if (data) {
                const ipkValueElement = document.getElementById('main-page-ipk-value');
                const ipkDonutElement = document.getElementById('ipk-donut');
                if (ipkValueElement) ipkValueElement.textContent = data.ipk;
                if (ipkDonutElement) {
                    const percentage = (parseFloat(data.ipk) / 4.00) * 100;
                    ipkDonutElement.style.background = `conic-gradient(#0b66a5 0% ${percentage}%, #f0b341 ${percentage}% 100%)`;
                }
                const totalSks = data.ips_per_semester.reduce((sum, semester) => sum + semester.total_sks, 0);
                const sksElement = document.getElementById('main-page-sks');
                if(sksElement) sksElement.textContent = totalSks;
                const semesterElement = document.getElementById('main-page-semester');
                const tahunAkademikElement = document.getElementById('main-page-tahun-akademik');
                if (data.ips_per_semester.length > 0) {
                    const lastSemester = data.ips_per_semester[data.ips_per_semester.length - 1];
                    if(semesterElement) semesterElement.textContent = data.ips_per_semester.length;
                    if(tahunAkademikElement) tahunAkademikElement.textContent = lastSemester.tahun_akademik;
                } else {
                    if(semesterElement) semesterElement.textContent = '0';
                    if(tahunAkademikElement) tahunAkademikElement.textContent = '-';
                }
            }
        } catch (error) {
            console.error('Terjadi masalah saat mengambil data IPS/IPK:', error);
            setText('#main-page-ipk-value', 'Error');
            setText('#main-page-sks', 'Error');
            setText('#main-page-semester', 'Error');
            setText('#main-page-tahun-akademik', 'Error');
        }
    }
    function getNamaHari() {
        const d = new Date();
        const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        return hari[d.getDay()];
    }
    async function fetchJadwalHariIni(nim) {
        if (!globalMahasiswaData) {
            await fetchDataAndPopulatePage();
        }
        const semester = globalMahasiswaData?.semester_sekarang;
        if (!nim || !semester) return;
        const url = `http://localhost/siakad_api/jadwal_kuliah.php?nim=${nim}&semester=${semester}`;
        const container = document.getElementById('jadwal-hari-ini-container');
        const hariIni = getNamaHari();
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Gagal memuat jadwal.');
            const apiResponse = await response.json();
            if (apiResponse.status === 'success' && apiResponse.data.length > 0) {
                const jadwalHariIni = apiResponse.data.filter(jadwal => jadwal.hari === hariIni);
                if (jadwalHariIni.length > 0) {
                    let htmlContent = `<div class="space-y-4">`;
                    jadwalHariIni.forEach(item => {
                        htmlContent += `
                            <div class="p-4 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                                <h3 class="font-bold text-base text-gray-800">${item.matkul}</h3>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${item.jam_mulai.substring(0, 5)} - ${item.jam_selesai.substring(0, 5)} | 
                                    Ruang: ${item.ruang} | Dosen: ${item.dosen}
                                </p>
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                    container.innerHTML = htmlContent;
                } else {
                    container.innerHTML = '<p class="text-sm text-gray-500 italic">Tidak ada jadwal kuliah untuk hari ini.</p>';
                }
            } else {
                container.innerHTML = '<p class="text-sm text-gray-500 italic">Tidak ada jadwal kuliah yang ditemukan.</p>';
            }
        } catch (error) {
            console.error('Terjadi masalah saat mengambil data jadwal:', error);
            container.innerHTML = '<p class="text-sm text-red-500 italic">Gagal memuat jadwal kuliah.</p>';
        }
    }
    document.addEventListener("DOMContentLoaded", () => {
        fetchDataAndPopulatePage();
    });
</script>